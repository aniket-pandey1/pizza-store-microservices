<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Orders - Pizza Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { margin: 0; background-color: #f4f6f8; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* Navbar */
        .navbar { width: 100%; max-width: 800px; background: #2c3e50; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; color: white; margin-bottom: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 15px; font-weight: bold; }
        .navbar h2 { margin: 0; }

        /* Order Card */
        .order-container { width: 100%; max-width: 800px; }
        .order-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; border-left: 5px solid #bdc3c7; display: flex; justify-content: space-between; align-items: center; }
        
        .order-info h3 { margin: 0 0 5px 0; color: #2c3e50; }
        .order-info p { margin: 0; color: #7f8c8d; font-size: 14px; }
        .price-tag { font-weight: bold; color: #27ae60; font-size: 18px; margin-top: 5px; display: block; }

        /* Action Area */
        .action-buttons { display: flex; gap: 10px; align-items: center; }

        /* Buttons */
        .btn-pay { background-color: #2980b9; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-pay:hover { background-color: #1abc9c; }

        .btn-cancel { background-color: white; color: #e74c3c; border: 1px solid #e74c3c; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-cancel:hover { background-color: #e74c3c; color: white; }
        
        /* Badges */
        .badge-paid { background-color: #27ae60; color: white; padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-cancelled { background-color: #e74c3c; color: white; padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="navbar">
        <h2>üçï My Pizza Orders</h2>
        <div>
            <a href="index.html">Home</a>
            <a href="admin-login.html" onclick="localStorage.clear()">Logout</a>
        </div>
    </div>

    <div class="order-container" id="ordersList">
        <p style="text-align:center; color:#7f8c8d;">Loading your orders...</p>
    </div>

    <script>
        // --- GATEWAY CONFIGURATION ---
        const GATEWAY_URL = "http://localhost:8080";
        
        const email = localStorage.getItem("userEmail"); 
        
        const ORDER_API = `${GATEWAY_URL}/order`;
        const PAYMENT_API = `${GATEWAY_URL}/payment`;

        window.onload = loadOrders;

        async function loadOrders() {
            if(!email) {
                alert("Please login first!");
                window.location.href = "index.html";
                return;
            }

            try {
                // Fetch orders for logged in user
                const response = await fetch(`${ORDER_API}/myorders/${email}`);
                if (!response.ok) throw new Error("Failed to fetch orders");
                const orders = await response.json();
                renderOrders(orders);
            } catch (error) {
                console.error("Error loading orders:", error);
                document.getElementById("ordersList").innerHTML = "<p>Error loading orders. Is the Gateway (8080) running?</p>";
            }
        }

        async function renderOrders(orders) {
            const container = document.getElementById("ordersList");
            container.innerHTML = "";

            if(orders.length === 0) {
                container.innerHTML = "<p style='text-align:center;'>No orders found. Go eat some pizza!</p>";
                return;
            }

            // Iterate through orders
            for (const order of orders) {
                
                let isPaid = false;
                try {
                    // Check Payment Status
                    const payRes = await fetch(`${PAYMENT_API}/${order.orderId}`);
                    const payData = await payRes.json();
                    if(payData && payData.status === "SUCCESS") {
                        isPaid = true;
                    }
                } catch(e) { console.log("Payment check failed for order " + order.orderId); }

                const div = document.createElement("div");
                div.className = "order-card";
                
                let actionHtml = "";
                
                // Logic: What buttons to show?
                if (order.status === "Cancelled") {
                    div.style.borderLeftColor = "#e74c3c";
                    actionHtml = `<span class="badge-cancelled">CANCELLED</span>`;
                } else if (isPaid) {
                    div.style.borderLeftColor = "#27ae60";
                    actionHtml = `<span class="badge-paid">‚úì PAID</span>`;
                } else {
                    // Active Order: Show Pay AND Cancel
                    div.style.borderLeftColor = "#f1c40f"; 
                    actionHtml = `
                        <div class="action-buttons">
                            <button class="btn-cancel" onclick="cancelOrder(${order.orderId})">Cancel</button>
                            <button class="btn-pay" onclick="handlePayment(${order.orderId}, ${order.price})">Pay ‚Çπ${order.price}</button>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div class="order-info">
                        <h3>${order.pizzaName} (${order.size})</h3>
                        <p>Order ID: #${order.orderId} | Status: ${order.status}</p>
                        <span class="price-tag">‚Çπ${order.price}</span>
                    </div>
                    <div>
                        ${actionHtml}
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // --- NEW: Cancel Order Function ---
        async function cancelOrder(orderId) {
            if(!confirm("Are you sure you want to cancel Order #" + orderId + "?")) return;

            try {
                // Call the PUT API we made earlier
                const response = await fetch(`${ORDER_API}/cancel/${orderId}`, {
                    method: 'PUT'
                });

                if(response.ok) {
                    alert("Order Cancelled Successfully. Amount (if any) will be refunded.");
                    loadOrders(); // Refresh the list
                } else {
                    const msg = await response.text();
                    alert("Failed to cancel: " + msg);
                }
            } catch(e) {
                console.error(e);
                alert("Error connecting to Gateway");
            }
        }

        async function handlePayment(orderId, amount) {
            const paymentMode = prompt("Enter Payment Mode (Cash/Card/UPI):", "UPI");
            if(!paymentMode) return;

            const paymentData = {
                orderId: orderId,
                amount: amount,
                paymentMode: paymentMode
            };

            try {
                const response = await fetch(`${PAYMENT_API}/doPay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });

                if(response.ok) {
                    alert("Payment Successful! üí∏");
                    loadOrders(); 
                } else {
                    alert("Payment Failed.");
                }
            } catch(e) {
                console.error(e);
                alert("Error processing payment via Gateway");
            }
        }
    </script>
</body>
</html>