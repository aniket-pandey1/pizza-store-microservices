<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Portal - Pizza Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background-color: #f4f6f8; }

        /* SIDEBAR */
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { margin-top: 0; font-size: 22px; border-bottom: 1px solid #34495e; padding-bottom: 15px; }
        .sidebar a { color: #ecf0f1; text-decoration: none; padding: 12px; margin-bottom: 5px; border-radius: 4px; display: block; }
        .sidebar a:hover, .sidebar a.active { background-color: #34495e; }
        .logout-btn { margin-top: auto; background-color: #c0392b; text-align: center; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }

        /* CONTROLS */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ddd; }

        /* FORM & CARDS */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 30px; border-top: 4px solid #27ae60; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: end; }
        .input-group label { display: block; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* BUTTONS */
        .btn-submit { background-color: #27ae60; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-submit:hover { background-color: #219150; }
        
        /* New Update Mode Colors */
        .card.edit-mode { border-top-color: #f39c12; }
        .btn-submit.edit-mode { background-color: #f39c12; }
        .btn-submit.edit-mode:hover { background-color: #e67e22; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        th { background-color: #ecf0f1; color: #2c3e50; text-align: left; padding: 15px; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #ecf0f1; color: #555; vertical-align: middle; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-Veg { background-color: #e8f5e9; color: #2e7d32; }
        .badge-Non-Veg { background-color: #ffebee; color: #c62828; }
        .badge-Beverages { background-color: #e3f2fd; color: #1565c0; }

        /* Action Buttons */
        .btn-icon { border: none; background: none; cursor: pointer; padding: 5px; font-size: 18px; transition: transform 0.2s; }
        .btn-icon:hover { transform: scale(1.2); }
        .btn-edit { color: #f39c12; }
        .btn-delete { color: #e74c3c; }

        /* Revenue Specific */
        .revenue-card { background: #2c3e50; color: white; border-top: 4px solid #f1c40f; display: flex; justify-content: space-between; align-items: center; }
        .refresh-btn { background: #f1c40f; color: #2c3e50; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Admin Panel</h2>
        <a href="#" class="active">üçï Menu Management</a>
        <a href="admin-orders.html">üì¶ Orders (View Only)</a>
        <a href="index.html" class="logout-btn">Logout</a>
    </div>

    <div class="main-content">
        
        <div class="card revenue-card">
            <div>
                <h3 style="margin:0; font-weight: 300;">üí∞ Total Shop Revenue</h3>
                <h1 id="revenueDisplay" style="margin: 5px 0;">Loading...</h1>
            </div>
            <button class="refresh-btn" onclick="loadRevenue()">Refresh Data</button>
        </div>

        <div class="card" id="formCard">
            <h3 id="formTitle">+ Add New Menu Item</h3>
            <input type="hidden" id="editPizzaId">
            
            <div class="form-grid">
                <div class="input-group">
                    <label>Item Name</label>
                    <input type="text" id="itemName" placeholder="Ex: Farmhouse">
                </div>
                <div class="input-group">
                    <label>Category</label>
                    <select id="category">
                        <option value="Veg">Veg Pizza</option>
                        <option value="Non-Veg">Non-Veg Pizza</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Sides">Sides</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Size</label>
                    <select id="size">
                        <option value="Regular">Regular</option>
                        <option value="Medium">Medium</option>
                        <option value="Large">Large</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Price (‚Çπ)</label>
                    <input type="number" id="price" placeholder="Ex: 299">
                </div>
                <button class="btn-submit" id="submitBtn" onclick="handleFormSubmit()">ADD ITEM</button>
            </div>
        </div>

        <div class="page-header">
            <h3>Current Menu</h3>
            <div class="controls">
                <select id="filterCategory" onchange="applyFilters()">
                    <option value="All">All Categories</option>
                    <option value="Veg">Veg</option>
                    <option value="Non-Veg">Non-Veg</option>
                </select>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Size</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="pizzaTableBody">
                </tbody>
        </table>

    </div>

    <script>
        // --- 1. GATEWAY CONFIGURATION ---
        // EVERYTHING must go through port 8080 now
        const GATEWAY_URL = "http://localhost:8080"; 
        
        const PIZZA_API = `${GATEWAY_URL}/pizza`;     // Points to Gateway -> Pizza Service
        const ORDER_API = `${GATEWAY_URL}/order`;     // Points to Gateway -> Order Service

        let allPizzas = [];

        window.onload = function() { 
            loadPizzas(); 
            loadRevenue(); 
        };

        // --- REVENUE LOGIC ---
        async function loadRevenue() {
            try {
                // IMPORTANT: Ensure your BillRepository has the @Query logic!
                const response = await fetch(`${ORDER_API}/revenue`);
                
                if (response.ok) {
                    const total = await response.json();
                    // If DB returns null (no sales yet), show 0.00
                    const formatted = (total || 0).toFixed(2);
                    document.getElementById("revenueDisplay").innerText = "‚Çπ " + formatted;
                } else {
                    document.getElementById("revenueDisplay").innerText = "‚Çπ 0.00 (No Sales)";
                }
            } catch (error) {
                console.error("Revenue Error:", error);
                document.getElementById("revenueDisplay").innerText = "‚Çπ 0.00 (Offline)";
            }
        }

        async function loadPizzas() {
            try {
                const response = await fetch(`${PIZZA_API}/all`);
                allPizzas = await response.json();
                renderTable(allPizzas);
            } catch (error) {
                console.error("Error loading pizzas:", error);
                document.getElementById("pizzaTableBody").innerHTML = "<tr><td colspan='6'>Failed to load menu. Check Gateway.</td></tr>";
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById("pizzaTableBody");
            tableBody.innerHTML = "";
            data.forEach(pizza => {
                const row = `<tr>
                    <td>#${pizza.pizzaId}</td>
                    <td><strong>${pizza.itemName}</strong></td>
                    <td><span class="badge badge-${pizza.category}">${pizza.category}</span></td>
                    <td>${pizza.size}</td>
                    <td>‚Çπ${pizza.price}</td>
                    <td>
                        <button class="btn-icon btn-edit" onclick="startEdit(${pizza.pizzaId})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="deletePizza(${pizza.pizzaId})" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        async function deletePizza(id) {
            if(!confirm("Are you sure you want to delete this item?")) return;

            try {
                const response = await fetch(`${PIZZA_API}/delete/${id}`, { method: 'DELETE' });
                if(response.ok) {
                    alert("Item Deleted!");
                    loadPizzas();
                } else {
                    alert("Delete failed.");
                }
            } catch(e) { console.error(e); }
        }

        function startEdit(id) {
            const pizza = allPizzas.find(p => p.pizzaId === id);
            if(!pizza) return;

            document.getElementById("editPizzaId").value = pizza.pizzaId;
            document.getElementById("itemName").value = pizza.itemName;
            document.getElementById("category").value = pizza.category;
            document.getElementById("size").value = pizza.size;
            document.getElementById("price").value = pizza.price;

            const btn = document.getElementById("submitBtn");
            const card = document.getElementById("formCard");
            const title = document.getElementById("formTitle");

            btn.innerText = "UPDATE ITEM";
            title.innerText = "‚úèÔ∏è Edit Menu Item";
            btn.classList.add("edit-mode");
            card.classList.add("edit-mode");
        }

        async function handleFormSubmit() {
            const id = document.getElementById("editPizzaId").value;
            
            const pizzaData = {
                itemName: document.getElementById("itemName").value,
                category: document.getElementById("category").value,
                size: document.getElementById("size").value,
                price: document.getElementById("price").value
            };

            if(!pizzaData.itemName || !pizzaData.price) {
                alert("Please fill all fields");
                return;
            }

            let method = 'POST';
            let url = `${PIZZA_API}/add`;

            if(id) {
                method = 'PUT';
                // FIXED: Include ID in the URL for update
                url = `${PIZZA_API}/update/${id}`;
                pizzaData.pizzaId = id; 
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pizzaData)
                });

                if (response.ok) {
                    alert(id ? "Updated Successfully!" : "Added Successfully!");
                    resetForm();
                    loadPizzas();
                } else {
                    alert("Operation Failed: " + response.status);
                }
            } catch (error) { console.error(error); }
        }

        function resetForm() {
            document.getElementById("editPizzaId").value = "";
            document.getElementById("itemName").value = "";
            document.getElementById("price").value = "";
            
            const btn = document.getElementById("submitBtn");
            const card = document.getElementById("formCard");
            const title = document.getElementById("formTitle");

            btn.innerText = "ADD ITEM";
            title.innerText = "+ Add New Menu Item";
            btn.classList.remove("edit-mode");
            card.classList.remove("edit-mode");
        }

        function applyFilters() {
            const cat = document.getElementById("filterCategory").value;
            const filtered = allPizzas.filter(p => cat === "All" || p.category === cat);
            renderTable(filtered);
        }
    </script>
</body>
</html>